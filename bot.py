import csv
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler

# Survey data
survey = [
    {
        "question": "–ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–æ–≥–¥–∞ —Ç–µ–±—è —Ö–≤–∞–ª—è—Ç –∑–∞ —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É?",
        "answers": [
            {"text": "–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –ø–æ—Ö–≤–∞–ª–∞ –∑–∞—Å–ª—É–∂–µ–Ω–Ω–∞—è", "score": 2},
            {"text": "–ü—Ä–∏—è—Ç–Ω–æ, –Ω–æ –Ω–µ —Ñ–æ–∫—É—Å–∏—Ä—É—é—Å—å –Ω–∞ —ç—Ç–æ–º", "score": 4},
            {"text": "–ù–µ–º–Ω–æ–≥–æ –Ω–µ–ª–æ–≤–∫–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –º–æ–≥(–ª–∞) –±—ã —Å–¥–µ–ª–∞—Ç—å –ª—É—á—à–µ", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –ª—é–¥–∏ –ø—Ä–æ—Å—Ç–æ –≤–µ–∂–ª–∏–≤—ã–µ –∏ –Ω–µ –≥–æ–≤–æ—Ä—è—Ç –ø—Ä–∞–≤–¥—É", "score": 8},
            {"text": "–û—â—É—â–∞—é, —á—Ç–æ –º–µ–Ω—è –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞—é—Ç", "score": 10},
            {"text": "test", "score": 20}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ —Å–≤–æ–∏–º —É—Å–ø–µ—Ö–∞–º?",
        "answers": [
            {"text": "–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –º–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è ‚Äì —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∏—Ö —É—Å–∏–ª–∏–π –∏ –Ω–∞–≤—ã–∫–æ–≤", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ –¥—É–º–∞—é, —á—Ç–æ —É—Å–ø–µ—Ö —Å–≤—è–∑–∞–Ω —Å —É–¥–∞—á–µ–π", "score": 4},
            {"text": "–°—Ç–∞—Ä–∞—é—Å—å –Ω–µ –ø—Ä–∏–¥–∞–≤–∞—Ç—å –∏–º –±–æ–ª—å—à–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–∫–∞–∑–∞–ª—Å—è(–∞—Å—å) –≤ –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ", "score": 8},
            {"text": "–û—â—É—â–∞—é, —á—Ç–æ —è –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ä–æ—à–æ –º–∞—Å–∫–∏—Ä—É—é—Å—å, –∏ —Å–∫–æ—Ä–æ —ç—Ç–æ –≤—Å–∫—Ä–æ–µ—Ç—Å—è", "score": 10}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å, –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º?",
        "answers": [
            {"text": "–û—Ö–æ—Ç–Ω–æ –¥–µ–ª—é—Å—å, –≤–µ–¥—å –∑–Ω–∞—é, —á—Ç–æ —É –º–µ–Ω—è –µ—Å—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –æ–ø—ã—Ç", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ –¥–µ–ª—é—Å—å, –Ω–æ —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –µ—Å—Ç—å –ª—é–¥–∏, –∑–Ω–∞—é—â–∏–µ –±–æ–ª—å—à–µ", "score": 4},
            {"text": "–°–æ–º–Ω–µ–≤–∞—é—Å—å, —Å—Ç–æ–∏—Ç –ª–∏ –º–Ω–µ –¥–µ–ª–∏—Ç—å—Å—è, –≤–¥—Ä—É–≥ —Å–∫–∞–∂—É —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω(–Ω–∞) –∏ –º–Ω–µ –µ—â—ë —Ä–∞–Ω–æ", "score": 8},
            {"text": "–û—Ç–∫–∞–∑—ã–≤–∞—é—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ —Ö–æ—á—É, —á—Ç–æ–±—ã —É–∑–Ω–∞–ª–∏, —á—Ç–æ —è ¬´–Ω–µ —ç–∫—Å–ø–µ—Ä—Ç¬ª", "score": 10}
        ]
    },
    {
        "question": "–ö–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ —Ä–∞–±–æ—Ç—É, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å?",
        "answers": [
            {"text": "–í–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ —è —É–≤–µ—Ä–µ–Ω(–∞) –≤ —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ —Å–æ–º–Ω–µ–≤–∞—é—Å—å, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–≤–∏–≥–∞—é—Å—å –≤–ø–µ—Ä—ë–¥", "score": 4},
            {"text": "–û—Ç–∫–ª–∞–¥—ã–≤–∞—é —Å—Ç–∞—Ä—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–æ—é—Å—å, —á—Ç–æ –Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –µ—â—ë –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è, –ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å", "score": 8},
            {"text": "–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É—é –∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–æ—é—Å—å –ø—Ä–æ–≤–∞–ª–∞", "score": 10}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –æ—à–∏–±–∫–∞–º?",
        "answers": [
            {"text": "–í–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é –∏—Ö –∫–∞–∫ –æ–ø—ã—Ç –∏ —É—Ä–æ–∫–∏", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–∂–∏–≤–∞—é, –Ω–æ –∑–Ω–∞—é, —á—Ç–æ —ç—Ç–æ —á–∞—Å—Ç—å –ø—É—Ç–∏", "score": 4},
            {"text": "–ò—Å–ø—ã—Ç—ã–≤–∞—é —Å–∏–ª—å–Ω–æ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ–±–æ–ª—å—à–∞—è", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ª—é–¥–∏ –ø–æ–π–º—É—Ç, —á—Ç–æ —è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à(–∞)", "score": 8},
            {"text": "–û—â—É—â–∞—é, —á—Ç–æ –æ—à–∏–±–∫–∏ –¥–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —è –≤–æ–æ–±—â–µ –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω(–Ω–∞)", "score": 10}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ —É—Å–ø–µ—Ö–∏ –∫–æ–ª–ª–µ–≥/–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤?",
        "answers": [
            {"text": "–†–∞–¥—É—é—Å—å –∑–∞ –Ω–∏—Ö, —ç—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –º–µ–Ω—è —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è", "score": 2},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –µ—â—ë –±–æ–ª—å—à–µ —Å—Ç–∞—Ä–∞—Ç—å—Å—è", "score": 4},
            {"text": "–°—Ä–∞–≤–Ω–∏–≤–∞—é —Å–µ–±—è –∏ —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –æ—Ç—Å—Ç–∞—é", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –º–Ω–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ—Å—Ç–∏—á—å –∏—Ö —É—Ä–æ–≤–Ω—è", "score": 8},
            {"text": "–û—â—É—â–∞—é, —á—Ç–æ —è –≤–æ–æ–±—â–µ –Ω–µ –≤ –∏—Ö –ª–∏–≥–µ –∏ –Ω–µ –∏–º–µ—é –ø—Ä–∞–≤–∞ —Å–µ–±—è —Å –Ω–∏–º–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å", "score": 10}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è?",
        "answers": [
            {"text": "–î–µ–ª–∞—é –≤—ã–≤–æ–¥—ã –∏ –¥–µ–π—Å—Ç–≤—É—é", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ —Å–æ–º–Ω–µ–≤–∞—é—Å—å, –Ω–æ –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é –Ω–∞–¥–æ–ª–≥–æ", "score": 4},
            {"text": "–î–æ–ª–≥–æ –¥—É–º–∞—é –∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é —Ä–µ—à–µ–Ω–∏–µ", "score": 6},
            {"text": "–°–æ–±–∏—Ä–∞—é –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ–º–Ω–µ–≤–∞—é—Å—å", "score": 8},
            {"text": "–û—Ç–∫–ª–∞–¥—ã–≤–∞—é –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–æ—é—Å—å –æ—à–∏–±–∏—Ç—å—Å—è", "score": 10}
        ]
    },
    {
        "question": "–ö–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ —Å–≤–æ–µ–º—É —É—Ä–æ–≤–Ω—é –∑–Ω–∞–Ω–∏–π?",
        "answers": [
            {"text": "–Ø –∑–Ω–∞—é –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Å–≤–æ–µ–π —Å—Ñ–µ—Ä–µ", "score": 2},
            {"text": "–ò–Ω–æ–≥–¥–∞ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ –ø–æ—É—á–∏—Ç—å—Å—è", "score": 4},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –º–æ–π —É—Ä–æ–≤–µ–Ω—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã—Å–æ–∫", "score": 6},
            {"text": "–ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —è –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—é, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö", "score": 8},
            {"text": "–£–≤–µ—Ä–µ–Ω(–∞), —á—Ç–æ –º–Ω–µ –µ—â—ë —Ä–∞–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å, –Ω–∞–¥–æ –¥–æ—É—á–∏—Ç—å—Å—è", "score": 10}
        ]
    },
    {
        "question": "–ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–æ–≥–¥–∞ —Ç–µ–±–µ –¥–∞—é—Ç —Å–ª–æ–∂–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ?",
        "answers": [
            {"text": "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ —Å–ø—Ä–∞–≤–ª—é—Å—å", "score": 2},
            {"text": "–ù–µ–º–Ω–æ–≥–æ –≤–æ–ª–Ω–µ–Ω–∏—è, –Ω–æ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ä–∞–∑–±–µ—Ä—É—Å—å", "score": 4},
            {"text": "–°–æ–º–Ω–µ–≤–∞—é—Å—å, —Å–ø—Ä–∞–≤–ª—é—Å—å –ª–∏", "score": 6},
            {"text": "–î—É–º–∞—é, —á—Ç–æ –º–µ–Ω—è –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–ª–∏ –∏ —è –Ω–µ –≤—ã—Ç—è–Ω—É", "score": 8},
            {"text": "–•–æ—á—É –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–æ—é—Å—å –ø—Ä–æ–≤–∞–ª–∞", "score": 10}
        ]
    },
    {
        "question": "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥(–ª–∞) –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç —Å–∏–Ω–¥—Ä–æ–º–∞ —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞, —á—Ç–æ –±—ã –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?",
        "answers": [
            {"text": "–Ø –±—ã –ø—Ä–æ–¥–æ–ª–∂–∏–ª(–∞) —Ä–∞–±–æ—Ç–∞—Ç—å, –∫–∞–∫ –∏ —Å–µ–π—á–∞—Å, –Ω–æ —Å –±–æ–ª—å—à–∏–º —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º", "score": 2},
            {"text": "–Ø –±—ã –ø–µ—Ä–µ—Å—Ç–∞–ª(–∞) –±–æ—è—Ç—å—Å—è –≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–≤–æ–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö", "score": 4},
            {"text": "–Ø –±—ã —Å–º–æ–≥(–ª–∞) —É–≤–µ—Ä–µ–Ω–Ω–æ –±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤", "score": 6},
            {"text": "–Ø –±—ã –Ω–∞—á–∞–ª(–∞) –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –∞ –Ω–µ —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è", "score": 8},
            {"text": "–ú–æ—è –∂–∏–∑–Ω—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø–æ—Ç–æ–º—É —á—Ç–æ —è —Å–º–æ–≥(–ª–∞) –±—ã –¥–µ–ª–∞—Ç—å —Ç–æ, —á–µ–≥–æ –¥–∞–≤–Ω–æ –±–æ—é—Å—å", "score": 10}
        ]
    },
]

# States
WELCOME, QUESTION, SHOW_RESULT, FINAL_MESSAGE = range(4)

# Where we store per-user info during the survey
user_data = {}


# Result messages based on score
def get_result_message(score):
    if score <= 25:
        return ("üåü C–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å\n\n–¢—ã —É–º–µ–µ—à—å –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ "
                "—É–≤–µ—Ä–µ–Ω–Ω–æ –∏–¥—ë—à—å –≤–ø–µ—Ä—ë–¥. –î–∞–∂–µ –µ—Å–ª–∏ –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞—é—Ç —Å–æ–º–Ω–µ–Ω–∏—è, –æ–Ω–∏ –Ω–µ –º–µ—à–∞—é—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ. –¢—ã "
                "–º–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ—Ö–≤–∞–ª—É, –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—à—å —Å–≤–æ–∏ —É—Å–ø–µ—Ö–∏ –Ω–∞ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –∏ —É–º–µ–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å "
                "–∫—Ä–∏—Ç–∏–∫–æ–π.\n\nüìå –ù–∞ —á—Ç–æ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:\n–î–∞–∂–µ –µ—Å–ª–∏ —Å–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ –≤—ã—Ä–∞–∂–µ–Ω —Å–ª–∞–±–æ, "
                "–æ–Ω –º–æ–∂–µ—Ç –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö. –ò–Ω–æ–≥–¥–∞ –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É—é—Ç —Å–µ–±—è —É–≤–µ—Ä–µ–Ω–Ω–æ, "
                "–≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–Ω–∏–∂–∞—é—Ç —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –Ω–∞ 100%.\n\nüéÅ –ß—Ç–æ –¥–∞–ª—å—à–µ?\n–ß—Ç–æ–±—ã "
                "–µ—â—ë –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å, —á–µ–≥–æ —Ç—ã —Ö–æ—á–µ—à—å, –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Å–≤–æ–∏–º —Ü–µ–ª—è–º, —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞ –º–∏–Ω–∏-–≥–∞–π–¥ ¬´–ö–∞–∫ "
                "–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–ª–∏¬ª. –û–Ω –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ —á—ë—Ç–∫–æ —É–≤–∏–¥–µ—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç–æ–∏—Ç "
                "–¥–≤–∏–≥–∞—Ç—å—Å—è.")
    elif score <= 50:
        return "üôÇ You are balanced and thoughtful."
    else:
        return "üßò You are introspective and calm."


# Start command ‚Äî send welcome message
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    start_button = [[KeyboardButton("üöÄ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç")]]
    markup = ReplyKeyboardMarkup(start_button, one_time_keyboard=True, resize_keyboard=True)
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç, —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã–ª —Ç–µ—Å—Ç –Ω–∞ —Å–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞, –∏ —ç—Ç–æ —É–∂–µ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç "
        "–≤ —Ç–≤–æ–µ–π –≥–æ–ª–æ–≤–µ!\n\n–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –ø–æ–Ω—è—Ç—å:\n\n–ï—Å—Ç—å –ª–∏ —É —Ç–µ–±—è —Å–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω "
        "–≤—ã—Ä–∞–∂–µ–Ω\n\n–ö–∞–∫ –æ–Ω –º–µ—à–∞–µ—Ç —Ç–µ–±–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è, —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è\n\n–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è —Å—Ç–æ–ø–æ—Ä–∏—Ç ‚Äî "
        "—Å—Ç—Ä–∞—Ö —Ä–∞–∑–æ–±–ª–∞—á–µ–Ω–∏—è, –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º, –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è –∏–ª–∏ —Å–∏–Ω–¥—Ä–æ–º –≤–µ—á–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞\n\n–ö–∞–∫–∏–µ —à–∞–≥–∏ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å "
        "–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –∑–∞–Ω–∏–∂–∞—Ç—å —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å\n\n–ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∏—à—å –≤ –∫–æ–Ω—Ü–µ —Ç–µ—Å—Ç–∞:\n\n–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å "
        "—Å–∏–Ω–¥—Ä–æ–º —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ ‚Äì —Ä–∞–∑–±–æ—Ä —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∫ —Å —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å\n\n–ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äì –ø–æ–¥–∞—Ä–æ–∫: "
        "–º–∏–Ω–∏-–≥–∞–π–¥ ¬´–ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–ª–∏¬ª, —á—Ç–æ–±—ã —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ\n\n–¢–µ—Å—Ç –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ 1 "
        "–º–∏–Ω—É—Ç—É ‚Äì –∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ —É–∑–Ω–∞–≤–∞–π, —á—Ç–æ –º–µ—à–∞–µ—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥.",
        reply_markup=markup
    )
    return WELCOME


# Handle "Start Survey" button
async def begin_survey(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_chat.id
    user_data[user_id] = {"score": 0, "index": 0}
    return await ask_question(update, context)


# Ask a survey question
async def ask_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_chat.id
    index = user_data[user_id]["index"]

    if index >= len(survey):
        score = user_data[user_id]["score"]
        result_text = get_result_message(score)

        # Save name and score only
        username = update.effective_user.full_name or update.effective_user.username or f"user_{user_id}"
        with open("survey_results.csv", "a", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow([username, user_id, score, result_text])

        # Show result + "Next" button
        next_button = [[KeyboardButton("‚û°Ô∏è –î–∞–ª–µ–µ")]]
        markup = ReplyKeyboardMarkup(next_button, one_time_keyboard=True, resize_keyboard=True)

        await update.message.reply_text(f"‚úÖ –û–ø—Ä–æ—Å –ø—Ä–æ–π–¥–µ–Ω!\n–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}\n\n{result_text}",
                                        reply_markup=markup)
        return SHOW_RESULT

    # Otherwise ask next question
    question_data = survey[index]
    keyboard = [[ans["text"]] for ans in question_data["answers"]]
    markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    await update.message.reply_text(question_data["question"], reply_markup=markup)
    return QUESTION


# Handle each answer
async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_chat.id
    text = update.message.text
    index = user_data[user_id]["index"]
    question_data = survey[index]

    # Match selected answer to score
    for ans in question_data["answers"]:
        if ans["text"] == text:
            user_data[user_id]["score"] += ans["score"]
            break

    user_data[user_id]["index"] += 1
    return await ask_question(update, context)


# Final message after result
async def final_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üéâ Thanks for completing the survey!\n\nIf you'd like to share your results, feel free to forward them to a friend or retake the survey any time using /start.")
    return ConversationHandler.END


# Cancel command
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Survey cancelled.")
    return ConversationHandler.END


# Set up bot
def main():
    app = ApplicationBuilder().token("8090138169:AAGUFHYeKJNqNE3ng0IsLo83CYAWCt0fL3o").build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            WELCOME: [MessageHandler(filters.Regex("üöÄ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç"), begin_survey)],
            QUESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_answer)],
            SHOW_RESULT: [MessageHandler(filters.Regex("‚û°Ô∏è –î–∞–ª–µ–µ"), final_message)],
        },
        fallbacks=[CommandHandler("cancel", cancel)]
    )

    app.add_handler(conv_handler)
    app.run_polling()


if __name__ == '__main__':
    main()
